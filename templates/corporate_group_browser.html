{% extends "base.html" %}
{% block content %}

<!-- corporate_group_browser.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Corporate Group Browser</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css">
</head>
<body class="p-4">
  <h2>Corporate Groups</h2>
  <button class="btn btn-primary mb-3" onclick="openForm()">+ New Group</button>
  <button class="btn btn-secondary mb-3" onclick="exportPDF()">Export to PDF</button>
  <table id="groupTable" class="display" style="width:100%">
    <thead>
      <tr>
        <th>ID</th><th>Name</th><th>Description</th><th>Created</th><th>Actions</th>
      </tr>
    </thead>
  </table>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    $(document).ready(function () {
      $('#groupTable').DataTable({
        ajax: '/corporate_group_data',
        columns: [
          { data: 'id' },
          { data: 'group_name' },
          { data: 'group_description' },
          { data: 'created_at' },
          {
            data: null,
            render: function (row) {
              return `
                <button class='btn btn-sm btn-warning' onclick="openForm(${row.id})">Edit</button>
                <button class='btn btn-sm btn-danger' onclick="deleteGroup(${row.id})">Delete</button>
                <a href='/company_browser/${row.id}' class='btn btn-sm btn-info'>Companies</a>
              `;
            }
          }
        ]
      });
    });

    function openForm(id = null) {
      let url = '/corporate_group_form';
      if (id) url += `?edit=${id}`;
      const width = 600;
      const height = 500;

      const dualScreenLeft = window.screenLeft !== undefined ? window.screenLeft : screen.left;
      const dualScreenTop = window.screenTop !== undefined ? window.screenTop : screen.top;

      const windowWidth = window.innerWidth
        ? window.innerWidth
        : document.documentElement.clientWidth
        ? document.documentElement.clientWidth
        : screen.width;
      const windowHeight = window.innerHeight
        ? window.innerHeight
        : document.documentElement.clientHeight
        ? document.documentElement.clientHeight
        : screen.height;

      const left = dualScreenLeft + (windowWidth - width) / 2;
      const top = dualScreenTop + (windowHeight - height) / 2;

      window.open(
        url,
        '_blank',
        `width=${width},height=${height},top=${top},left=${left},resizable=yes,scrollbars=yes`
      );
    }

    function deleteGroup(id) {
      if (!confirm('Delete this group?')) return;
      fetch(`/corporate_group_delete/${id}`, { method: 'DELETE' })
        .then(res => res.json())
        .then(() => location.reload());
    }

    function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Corporate Group List", 10, 10);
      const rows = $('#groupTable').DataTable().rows().data();
      let y = 20;
      rows.each(r => {
        doc.text(`ID: ${r.id}, Name: ${r.group_name}, Desc: ${r.description}`, 10, y);
        y += 10;
      });
      doc.save("corporate_groups.pdf");
    }
  </script>
</body>
</html>
{% endblock %}
