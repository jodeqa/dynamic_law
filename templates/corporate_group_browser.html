{% extends "base.html" %}
{% block title %}SELMA Corporate Browser{% endblock %}
{% block content %}

<!-- corporate_group_browser.html -->
  <meta name="csrf-token" content="{{ csrf_token() }}">

  <h2>Corporate Groups</h2>
  <button class="btn btn-primary mb-3" onclick="openForm()">+ New Group</button>
  <button class="btn btn-secondary mb-3" onclick="exportPDF()">Export to PDF</button>
  <table id="groupTable" class="display" style="width:100%">
    <thead>
      <tr>
        <th>ID</th><th>Name</th><th>Description</th><th>Created</th><th>Actions</th>
      </tr>
    </thead>
  </table>
{% endblock %}

{% block scripts %}
  <script>
    $(document).ready(function () {
      $('#groupTable').DataTable({
        ajax: '/corporate_group_data',
        columns: [
          { data: 'id' },
          { data: 'group_name' },
          { data: 'group_description' },
          { data: 'created_at' },
          {
            data: null,
            render: function (row) {
              return `
                <button class='btn btn-sm btn-warning' onclick="openForm(${row.id})">Edit</button>
                <button class='btn btn-sm btn-danger' onclick="deleteGroup(${row.id})">Delete</button>
                <a href='/company_browser/${row.id}' class='btn btn-sm btn-info'>Companies</a>
              `;
            }
          }
        ]
      });
    });

    function openForm(id = null) {
      let url = '/corporate_group_form';
      if (id) url += `?edit=${id}`;
      const width = 600;
      const height = 500;

      const dualScreenLeft = window.screenLeft !== undefined ? window.screenLeft : screen.left;
      const dualScreenTop = window.screenTop !== undefined ? window.screenTop : screen.top;

      const windowWidth = window.innerWidth
        ? window.innerWidth
        : document.documentElement.clientWidth
        ? document.documentElement.clientWidth
        : screen.width;
      const windowHeight = window.innerHeight
        ? window.innerHeight
        : document.documentElement.clientHeight
        ? document.documentElement.clientHeight
        : screen.height;

      const left = dualScreenLeft + (windowWidth - width) / 2;
      const top = dualScreenTop + (windowHeight - height) / 2;

      window.open(
        url,
        '_blank',
        `width=${width},height=${height},top=${top},left=${left},resizable=yes,scrollbars=yes`
      );
    }

    function deleteGroup(id) {
      if (!confirm('Delete this group?')) return;
      const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
      fetch(`/corporate_group_delete/${id}`, {
          method: 'DELETE',
            headers: {
            'X-CSRFToken': csrfToken
            }
        })
        .then(res => res.json())
        .then(() => location.reload());
    }

    function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Corporate Group List", 10, 10);
      const rows = $('#groupTable').DataTable().rows().data();
      let y = 20;
      rows.each(r => {
        doc.text(`ID: ${r.id}, Name: ${r.group_name}, Desc: ${r.group_description}`, 10, y);
        y += 10;
      });
      doc.save("corporate_groups.pdf");
    }
  </script>
{% endblock %}
