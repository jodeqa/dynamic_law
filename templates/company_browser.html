{% extends "base.html" %}
{% block content %}

<!-- company_browser.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Company Browser</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .tree-toggle {
      cursor: pointer;
      margin-right: 6px;
      font-weight: bold;
      color: #0d6efd;
    }
    .tree-toggle:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body class="p-4">
  <h2>Companies in Group {{ group_id }}</h2>
  <button class="btn btn-primary mb-2" onclick="openCompanyForm()">+ New Company</button>
  <button class="btn btn-outline-secondary mb-2" onclick="toggleView()">Toggle Table/Tree</button>
  <div id="tree-container" class="mt-3"></div>
  <div id="table-container" class="mt-3" style="display:none">
    <table id="companyTable" class="table table-bordered">
      <thead><tr><th>Code</th><th>Name</th><th>Next Inspection</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

    <!-- Modal for Compliance Management -->
  <div class="modal fade" id="complianceModal" tabindex="-1" aria-labelledby="complianceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="complianceModalLabel">Compliance History</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <iframe id="complianceFrame" style="width:100%; height:600px; border:none;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for companyData Management -->
  <div class="modal fade" id="companyDataModal" tabindex="-1" aria-labelledby="companyDataModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="companyDataModalLabel">Company Data History</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <iframe id="companyDataFrame" style="width:100%; height:600px; border:none;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <script>
    const groupId = {{ group_id }};

    async function loadTree() {
      const res = await fetch(`/company_tree_data/${groupId}`);
      const data = await res.json();
      document.getElementById('tree-container').innerHTML = renderTree(data);
      renderTable(data);
    }

    function renderTree(data) {
      let idCounter = 0;
      function build(parentId = null) {
        const nodes = data.filter(d => d.parent_id === parentId);
        if (!nodes.length) return '';
        let html = '<ul class="list-group ms-3">';
        nodes.forEach(node => {
          const hasChildren = data.some(d => d.parent_id === node.id);
          const subtreeId = `subtree-${idCounter++}`;
          html += `<li class="list-group-item">
              ${hasChildren ? `<span class="tree-toggle" onclick="toggleSubtree('${subtreeId}')">â–¶</span>` : ''}
              <strong>${node.input_code} - ${node.company_name}</strong>
              <span class="float-end">
                <button class="btn btn-sm btn-warning" onclick="openCompanyForm(${node.id})">Edit</button>
                <button class="btn btn-sm btn-danger" onclick="deleteCompany(${node.id})">Delete</button>
                <button class="btn btn-sm btn-info" onclick="openComplianceModal(${node.id})">Compliance</button>
                <button class="btn btn-sm btn-info" onclick="openCompanyDataModal(${node.id})">Data</button>
                <button class="btn btn-sm btn-outline-info" onclick="openMapping(${node.id})">Mapping</button>
              </span>
              <div id="${subtreeId}" style="display: none;">${build(node.id)}</div>
            </li>`;
        });
        html += '</ul>';
        return html;
      }
      return build();
    }

    function renderTable(data) {
      const tbody = document.querySelector("#companyTable tbody");
      tbody.innerHTML = '';
      data.forEach(row => {
        tbody.innerHTML += `
          <tr>
            <td>${row.input_code}</td>
            <td>${row.company_name}</td>
            <td>${row.next_inpection_date || '-'}</td>
            <td>
              <button class="btn btn-sm btn-warning" onclick="openCompanyForm(${row.id})">Edit</button>
              <button class="btn btn-sm btn-danger" onclick="deleteCompany(${row.id})">Delete</button>
              <button class="btn btn-sm btn-info" onclick="openComplianceModal(${row.id})">Compliance</button>
              <button class="btn btn-sm btn-info" onclick="openCompanyDataModal(${row.id})">Data</button>
              <button class="btn btn-sm btn-outline-info" onclick="openMapping(${row.id})">Mapping</button>
            </td>
          </tr>
        `;
      });
    }

    function toggleView() {
      const tree = document.getElementById("tree-container");
      const table = document.getElementById("table-container");
      tree.style.display = tree.style.display === "none" ? "block" : "none";
      table.style.display = table.style.display === "none" ? "block" : "none";
    }

    function toggleSubtree(id) {
      const el = document.getElementById(id);
      if (el) {
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
      }
    }

    function openCompanyForm(id = null) {
      let url = `/company_form.html?group_id=${groupId}`;
      if (id) url += `&edit=${id}`;

      const width = 600;
      const height = 500;

      // Get browser screen position
      const dualScreenLeft = window.screenLeft !== undefined ? window.screenLeft : screen.left;
      const dualScreenTop = window.screenTop !== undefined ? window.screenTop : screen.top;

      const windowWidth = window.innerWidth
        ? window.innerWidth
        : document.documentElement.clientWidth
        ? document.documentElement.clientWidth
        : screen.width;
      const windowHeight = window.innerHeight
        ? window.innerHeight
        : document.documentElement.clientHeight
        ? document.documentElement.clientHeight
        : screen.height;

      const left = dualScreenLeft + (windowWidth - width) / 2;
      const top = dualScreenTop + (windowHeight - height) / 2;

      const features = `scrollbars=yes,resizable=yes,width=${width},height=${height},top=${top},left=${left}`;

      // Use a consistent name to force separate popup instead of tab
      window.open(url, 'CompanyFormWindow', features);
    }

    async function deleteCompany(id) {
      if (!confirm('Delete this company?')) return;
      await fetch(`/company_delete/${id}`, { method: 'DELETE' });
      loadTree();
    }

    function openComplianceModal(companyId) {
      const iframe = document.getElementById("complianceFrame");
      iframe.src = `/company_template_browser/compliance/${companyId}`;
      new bootstrap.Modal(document.getElementById("complianceModal")).show();
    }

    function openCompanyDataModal(companyId) {
      const iframe = document.getElementById("companyDataFrame");
      iframe.src = `/company_template_browser/company_data/${companyId}`;   // <-- fix the URL here
      new bootstrap.Modal(document.getElementById("companyDataModal")).show();
    }

    function openMapping(companyId) {
      const width = 600;
      const height = 500;

      // Get browser screen position
      const dualScreenLeft = window.screenLeft !== undefined ? window.screenLeft : screen.left;
      const dualScreenTop = window.screenTop !== undefined ? window.screenTop : screen.top;

      const windowWidth = window.innerWidth
        ? window.innerWidth
        : document.documentElement.clientWidth
        ? document.documentElement.clientWidth
        : screen.width;
      const windowHeight = window.innerHeight
        ? window.innerHeight
        : document.documentElement.clientHeight
        ? document.documentElement.clientHeight
        : screen.height;

      const left = dualScreenLeft + (windowWidth - width) / 2;
      const top = dualScreenTop + (windowHeight - height) / 2;

      const features = `scrollbars=yes,resizable=yes,width=${width},height=${height},top=${top},left=${left}`;
      window.open(`/company_template_mapping_browser/${companyId}`, '_blank', features);
    }

    window.onload = loadTree;
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
{% endblock %}