{% extends "base.html" %}
{% block content %}

  <meta name="csrf-token" content="{{ csrf_token() }}">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 id="templateTitle">Template Browser</h2>
    <button class="btn btn-primary" id="btnAddTemplate">+ Add New Template</button>
  </div>
  <table id="templateTable" class="display" style="width:100%">
    <thead>
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Description</th>
        <th>Created</th>
        <th>Actions</th>
      </tr>
    </thead>
  </table>
{% endblock %}

{% block scripts %}
  <script>
    const params = new URLSearchParams(window.location.search);
    const datasetType = params.get("dataset_type");

    let fetchUrl = "";
    let title = "";
    let newTemplateUrl = "";

    if (datasetType === "company_data") {
      title = "Company Data Templates";
    } else if (datasetType === "compliance") {
      title = "Compliance Sheet Templates";
    } else {
      alert("Invalid dataset type");
    }

    document.getElementById("templateTitle").innerText = title;

    fetchUrl = `/dataset_template_browse_data/${datasetType}`;
    newTemplateUrl = `/dataset_template_form/${datasetType}`;

    $(document).ready(function () {
      $('#templateTable').DataTable({
        ajax: fetchUrl,
        columns: [
          { data: 'id' },
          { data: 'search_tag' },
          { data: 'description' },
          { data: 'created_at' },
          {
            data: null,
            render: function (row) {
              return `
                <button class="btn btn-sm btn-primary" onclick="openEditWindow(${row.id})">Edit Info</button>
                <a class="btn btn-sm btn-primary" href="/dataset_form_browser/${datasetType}/${row.id}/${row.search_tag}">Edit Structure</a>
                <button class="btn btn-sm btn-success copy-btn" onclick="copyTemplate(this, ${row.id})">Copy Template</button>
              `;
            }
          }
        ]
      });

      $('#btnAddTemplate').click(() => {

        const width = 600;
        const height = 500;

        // Get browser screen position
        const dualScreenLeft = window.screenLeft !== undefined ? window.screenLeft : screen.left;
        const dualScreenTop = window.screenTop !== undefined ? window.screenTop : screen.top;

        const windowWidth = window.innerWidth
          ? window.innerWidth
          : document.documentElement.clientWidth
          ? document.documentElement.clientWidth
          : screen.width;
        const windowHeight = window.innerHeight
          ? window.innerHeight
          : document.documentElement.clientHeight
          ? document.documentElement.clientHeight
          : screen.height;

        const left = dualScreenLeft + (windowWidth - width) / 2;
        const top = dualScreenTop + (windowHeight - height) / 2;

        const features = `scrollbars=yes,resizable=yes,width=${width},height=${height},top=${top},left=${left}`;
        const newWin = window.open(newTemplateUrl, '_blank', features);
          const timer = setInterval(() => {
            if (newWin.closed) {
              clearInterval(timer);
              $('#templateTable').DataTable().ajax.reload();
            }
	    }, 500);
	  });
    });

    function openEditWindow(templateId) {
      const width = 600;
      const height = 500;

      const dualScreenLeft = window.screenLeft !== undefined ? window.screenLeft : screen.left;
      const dualScreenTop = window.screenTop !== undefined ? window.screenTop : screen.top;

      const windowWidth = window.innerWidth || document.documentElement.clientWidth || screen.width;
      const windowHeight = window.innerHeight || document.documentElement.clientHeight || screen.height;

      const left = dualScreenLeft + (windowWidth - width) / 2;
      const top = dualScreenTop + (windowHeight - height) / 2;

      const features = `scrollbars=yes,resizable=yes,width=${width},height=${height},top=${top},left=${left}`;
      const newWin = window.open(`/dataset_template_form/${datasetType}/${templateId}`, '_blank', features);

      const timer = setInterval(() => {
        if (newWin.closed) {
          clearInterval(timer);
          $('#templateTable').DataTable().ajax.reload();
        }
      }, 500);
    }


    function copyTemplate(button, templateId) {
      if (!confirm('Copy this template?')) return;

      button.disabled = true;
      const oldText = button.innerHTML;
      button.innerHTML = 'Copying...';
      const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
      fetch(`/copy_template/${datasetType}/${templateId}`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': csrfToken
            }
          })
        .then(res => res.json())
        .then(data => {
          alert(data.message);
          if (data.new_id) {
            window.location.href = `/dataset_form_browser/${datasetType}/${data.new_id}`;
          }
        })
        .catch(err => {
          console.error(err);
          alert('Error copying template.');
        })
        .finally(() => {
          button.disabled = false;
          button.innerHTML = oldText;
        });
    }

  </script>

{% endblock %}
